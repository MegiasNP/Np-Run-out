<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NP BUS â€“ NP Realtime Yard Layout</title>

<style>
body{margin:0;font-family:Arial;background:#0A1628;color:#fff}
#menuBtn{display:none;position:fixed;top:10px;left:10px;z-index:1000;
background:#00D4FF;color:#022;border:none;border-radius:8px;padding:10px;font-size:20px}
.app{display:grid;grid-template-columns:320px 1fr;height:100vh}
.sidebar{background:#13233a;padding:14px;overflow:auto}
.main{position:relative}
.card{background:#0f1d31;padding:12px;border-radius:10px;margin-bottom:12px}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:none}
button{font-weight:bold;cursor:pointer}
.assign{background:#00D4FF;color:#022}
.fit{background:#22c55e;color:#022}
.unfit{background:#ef4444;color:#fff}
.clear{background:#f97316;color:#022}

.mapWrap{position:relative}
#map{width:100%;display:block}

.spot{
  position:absolute;
  border:2px solid #00D4FF;
  background:rgba(0,212,255,.25);
  cursor:pointer;
  user-select:none;

  display:flex;
  align-items:center;
  justify-content:center;

  overflow:hidden;        /* CLAVE anti-overlap */
  text-align:center;
}

/* contenedor interno */
.spot .label{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* bonnet number */
.spot .fleet{
  font-size:11px;          /* ðŸ”½ reducido */
  font-weight:700;
  white-space:nowrap;
  max-width:100%;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* id del parking (solo cuando estÃ¡ vacÃ­o) */
.spot .id{
  font-size:9px;
  opacity:0.6;
}



@media(max-width:768px){
.app{grid-template-columns:1fr}
.sidebar{position:fixed;left:-320px;top:0;bottom:0;width:320px;z-index:999}
.sidebar.open{left:0}
#menuBtn{display:block}
}
</style>
</head>

<body>

<button id="menuBtn">â˜°</button>

<div class="app">
  <div class="sidebar" id="sidebar">
    <h2>NP BUS</h2>

    <div class="card">
      <input id="searchInput" placeholder="Search fleet / bonnet">
      <button onclick="searchBus()">SEARCH</button>
    </div>

    <div class="card">
      <button class="assign" onclick="assignBus()">ASSIGN BUS</button>
      <button class="unfit" onclick="markUnfit()">MARK NO FIT</button>
      <button class="fit" onclick="markFit()">MARK FIT</button>
      <button class="clear" onclick="clearSpot()">CLEAR</button>
    </div>

    <div class="card">
      Selected: <b id="sel">â€”</b>
    </div>
  </div>

  <div class="main">
    <div class="mapWrap">
      <img id="map" src="depot-map_1_.jpg" alt="Depot map">
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const FIREBASE = "https://np-run-out-default-rtdb.firebaseio.com";
const LAYOUT_FILE = "spots-layout.json";     // tu archivo de coordenadas (array)
const FALLBACK_FILE = "parking-progress.json"; // opcional, por si falla Firebase
/* ========================================== */

let layout = [];
let data = {};            // { "31": {fleetNumber:"ws137", status:"NO FIT"}, ... }
let selected = null;
let highlight = null;
let highlightUntil = 0;

const map = document.getElementById("map");
const wrap = document.querySelector(".mapWrap");

/* ---------- LOADERS ---------- */
async function loadLayout(){
  layout = await fetch(LAYOUT_FILE).then(r => r.json());
}

async function loadFirebaseData(){
  const r = await fetch(`${FIREBASE}/spots.json`);
  const j = await r.json();
  return j || {};
}

// si tu parking-progress.json tiene estructura {spots:[...]} o { "31": {...} }
async function loadFallbackData(){
  const r = await fetch(FALLBACK_FILE);
  const j = await r.json();
  if(!j) return {};
  if(Array.isArray(j.spots)){
    // convertir array [{id:"31", fleetNumber:"ws137"...}] => objeto por id
    const out = {};
    for(const it of j.spots){
      if(it && it.id != null) out[String(it.id)] = it;
    }
    return out;
  }
  return j; // si ya viene como objeto por id
}

async function refresh(){
  try{
    data = await loadFirebaseData();
  }catch(e){
    // fallback solo si Firebase falla
    try { data = await loadFallbackData(); }
    catch(_) { data = {}; }
  }
  draw();
}

/* ---------- DRAW ---------- */
function draw(){
  document.querySelectorAll(".spot").forEach(e => e.remove());

  function draw(){
  if(!map.naturalWidth || !map.naturalHeight) return;

  document.querySelectorAll(".spot").forEach(e => e.remove());

  const sx = map.clientWidth / map.naturalWidth;
  const sy = map.clientHeight / map.naturalHeight;
  const now = Date.now();

  layout.forEach(s => {
    const d = document.createElement("div");
    d.className = "spot";

    const id = String(s.id);
    const st = data?.[id];

    if(st?.status === "NO FIT") d.classList.add("nofit");
    else if(st?.status === "FIT") d.classList.add("fit");

    if(id === selected) d.classList.add("selected");
    if(id === highlight && now < highlightUntil) d.classList.add("highlight");

    const pw = s.w * sx;
    const ph = s.h * sy;

    d.style.left   = (s.x * sx) + "px";
    d.style.top    = (s.y * sy) + "px";
    d.style.width  = pw + "px";
    d.style.height = ph + "px";

    const rot = Number(s.rotation || 0);
    d.style.transform = `rotate(${rot}deg)`;
    d.style.transformOrigin = "center center";

    // ðŸ”  tamaÃ±o automÃ¡tico del texto
    let fontSize = Math.min(pw, ph) * 0.45;
    fontSize = Math.max(8, Math.min(fontSize, 18));

    const hasBus = !!st?.fleetNumber;

    d.innerHTML = `
      <div class="label" style="font-size:${fontSize}px">
        ${hasBus
          ? `<div class="fleet">${st.fleetNumber.toUpperCase()}</div>`
          : `<div class="id">${id}</div>`
        }
      </div>
    `;

    d.onclick = () => {
      selected = id;
      document.getElementById("sel").textContent = id;
      draw();
    };

    wrap.appendChild(d);
  });
}


/* ---------- SAVE ---------- */
async function save(id, payload){
  await fetch(`${FIREBASE}/spots/${id}.json`, {
    method:"PATCH",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  await refresh();
}

/* ---------- ACTIONS ---------- */
function searchBus(){
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  if(!q) return;

  for(const id in data){
    if(String(data[id]?.fleetNumber || "").toLowerCase() === q){
      highlight = id;
      highlightUntil = Date.now() + 4000;
      selected = id;
      document.getElementById("sel").textContent = id;
      draw();
      return;
    }
  }
  alert("Bus not found");
}

function assignBus(){
  if(!selected) return alert("Select a parking first");
  if(data[selected]?.status === "NO FIT") return alert("NO FIT â€“ mark FIT first");

  const fleet = prompt(`Fleet / bonnet for spot ${selected}:`);
  if(!fleet) return;

  save(selected, {
    fleetNumber: fleet.trim().toLowerCase(),
    status: data[selected]?.status || "FIT"
  });
}

function markUnfit(){
  if(!selected) return alert("Select a parking first");
  save(selected, { status:"NO FIT" });
}

function markFit(){
  if(!selected) return alert("Select a parking first");
  save(selected, { status:"FIT" });
}

function clearSpot(){
  if(!selected) return alert("Select a parking first");
  fetch(`${FIREBASE}/spots/${selected}.json`, { method:"DELETE" })
    .then(refresh);
}

/* ---------- UI ---------- */
document.getElementById("menuBtn").onclick = () => {
  document.getElementById("sidebar").classList.toggle("open");
};

map.onload = async () => {
  await loadLayout();
  await refresh();
  setInterval(refresh, 5000);
};

</script>

</body>
</html>
