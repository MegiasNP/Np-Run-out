<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NP BUS – NP Realtime Yard Layout</title>

<style>
body{margin:0;font-family:Arial;background:#0A1628;color:#fff}
#menuBtn{display:none;position:fixed;top:10px;left:10px;z-index:1000;
background:#00D4FF;color:#022;border:none;border-radius:8px;padding:10px;font-size:20px}
.app{display:grid;grid-template-columns:320px 1fr;height:100vh}
.sidebar{background:#13233a;padding:14px;overflow:auto}
.main{position:relative}
.card{background:#0f1d31;padding:12px;border-radius:10px;margin-bottom:12px}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:none}
button{font-weight:bold;cursor:pointer}
.assign{background:#00D4FF;color:#022}
.fit{background:#22c55e;color:#022}
.unfit{background:#ef4444;color:#fff}
.clear{background:#f97316;color:#022}

.mapWrap{position:relative}
#map{width:100%;display:block}
.spot{
position:absolute;border:2px solid #00D4FF;
background:rgba(0,212,255,.25);color:#fff;
font-size:12px;font-weight:bold;text-align:center;
cursor:pointer;user-select:none
}
.spot.fit{background:rgba(34,197,94,.6)}
.spot.nofit{background:rgba(239,68,68,.7)}
.spot.selected{outline:3px solid #fff}
.spot.highlight{outline:4px solid #000;z-index:20}

@media(max-width:768px){
.app{grid-template-columns:1fr}
.sidebar{position:fixed;left:-320px;top:0;bottom:0;width:320px;z-index:999}
.sidebar.open{left:0}
#menuBtn{display:block}
}
</style>
</head>

<body>

<button id="menuBtn">☰</button>

<div class="app">
<div class="sidebar" id="sidebar">
  <h2>NP BUS</h2>

  <div class="card">
    <input id="searchInput" placeholder="Search fleet / bonnet">
    <button onclick="searchBus()">SEARCH</button>
  </div>

  <div class="card">
    <button class="assign" onclick="assignBus()">ASSIGN BUS</button>
    <button class="unfit" onclick="markUnfit()">MARK NO FIT</button>
    <button class="fit" onclick="markFit()">MARK FIT</button>
    <button class="clear" onclick="clearSpot()">CLEAR</button>
  </div>

  <div class="card">
    Selected: <b id="sel">—</b>
  </div>
</div>

<div class="main">
  <div class="mapWrap">
    <img id="map" src="depot-map_1_.jpg">
  </div>
</div>
</div>

<script>
const FIREBASE="https://np-run-out-default-rtdb.firebaseio.com";
const LAYOUT="spots-layout.json";

let layout=[],data={},selected=null,highlight=null,hlUntil=0;

const map=document.getElementById("map");
const wrap=document.querySelector(".mapWrap");

async function loadLayout(){
  layout=await fetch(LAYOUT).then(r=>r.json());
}
async function refresh(){
  data=await fetch(FIREBASE+"/spots.json").then(r=>r.json())||{};
  draw();
}
function draw(){
  document.querySelectorAll(".spot").forEach(e=>e.remove());
  const sx=map.clientWidth/map.naturalWidth;
  const sy=map.clientHeight/map.naturalHeight;
  const now=Date.now();

  layout.forEach(s=>{
    const d=document.createElement("div");
    d.className="spot";
    const st=data[s.id];
    if(st?.status==="NO FIT") d.classList.add("nofit");
    else if(st?.status==="FIT") d.classList.add("fit");
    if(s.id===selected) d.classList.add("selected");
    if(s.id===highlight && now<hlUntil) d.classList.add("highlight");

    d.style.left=s.x*sx+"px";
    d.style.top=s.y*sy+"px";
    d.style.width=s.w*sx+"px";
    d.style.height=s.h*sy+"px";
    d.style.transform=`rotate(${s.rotation||0}deg)`;
    d.textContent=s.id;

    d.onclick=()=>{selected=s.id;document.getElementById("sel").textContent=s.id;draw()};
    wrap.appendChild(d);
  });
}

async function save(id,payload){
  await fetch(`${FIREBASE}/spots/${id}.json`,{
    method:"PATCH",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  refresh();
}

function searchBus(){
  const q=document.getElementById("searchInput").value.toLowerCase();
  for(const id in data){
    if(data[id].fleetNumber===q){
      highlight=id;hlUntil=Date.now()+4000;selected=id;
      document.getElementById("sel").textContent=id;
      draw();return;
    }
  }
  alert("Bus not found");
}

function assignBus(){
  if(!selected) return alert("Select a parking");
  if(data[selected]?.status==="NO FIT") return alert("NO FIT – mark FIT first");
  const fleet=prompt("Fleet / bonnet:");
  if(!fleet) return;
  save(selected,{fleetNumber:fleet.toLowerCase(),status:"FIT"});
}
function markUnfit(){ if(selected) save(selected,{status:"NO FIT"}) }
function markFit(){ if(selected) save(selected,{status:"FIT"}) }
function clearSpot(){
  if(!selected) return;
  fetch(`${FIREBASE}/spots/${selected}.json`,{method:"DELETE"}).then(refresh);
}

document.getElementById("menuBtn").onclick=()=>{
document.getElementById("sidebar").classList.toggle("open");
};

map.onload=()=>draw();
loadLayout().then(refresh);
setInterval(refresh,6000);
</script>

</body>
</html>
