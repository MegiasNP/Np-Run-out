<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NP BUS – NP Realtime Yard Layout</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#0b1a2a;
  color:#fff;
}
#sidebar{
  position:fixed;
  left:0;
  top:0;
  bottom:0;
  width:300px;
  background:#0f243a;
  padding:15px;
  overflow:auto;
}
#menuBtn{
  display:none;
}
h2{margin-top:0;color:#4fd1ff;}
input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border:none;
  border-radius:6px;
  font-size:15px;
}
button{cursor:pointer}
.search{background:#19c8ff;color:#000;font-weight:bold;}
.assign{background:#1bbcff;}
.fit{background:#2ecc71;}
.clear{background:#e74c3c;}

#mapWrap{
  margin-left:300px;
  padding:10px;
}
#map{
  position:relative;
}
.spot{
  position:absolute;
  border:2px solid #00cfff;
  background:rgba(0,200,255,0.15);
  color:#fff;
  font-size:12px;
  text-align:center;
  cursor:pointer;
}
.spot.selected{
  outline:3px solid yellow;
}
.spot.fit{
  background:rgba(46,204,113,0.6);
}
.spot.nofit{
  background:rgba(231,76,60,0.7);
}
.spot.highlight{
  outline:4px solid #000;
  z-index:999;
}

@media(max-width:768px){
  #sidebar{left:-300px}
  #sidebar.open{left:0}
  #menuBtn{
    display:block;
    position:fixed;
    top:10px;
    left:10px;
    z-index:2000;
    background:#19c8ff;
    color:#000;
    padding:10px;
    border-radius:6px;
    font-weight:bold;
  }
  #mapWrap{margin-left:0}
}
</style>
</head>

<body>

<button id="menuBtn">☰</button>

<div id="sidebar">
  <h2>NP BUS</h2>

  <input id="searchInput" placeholder="e.g. ws50">
  <button class="search" onclick="searchBus()">Search</button>

  <button class="assign" onclick="assignBus()">ASSIGN BUS</button>
  <button class="fit" onclick="markFit()">MARK AS FIT</button>
  <button class="clear" onclick="clearSpot()">CLEAR SPOT</button>
</div>

<div id="mapWrap">
  <div id="map">
    <img src="depot-map_1_.jpg" style="width:100%;display:block;">
  </div>
</div>

<script>
const DATABASE_URL = "parking-progress-1765754484135.json";

let spotsData = {};
let selectedSpotId = null;

// ---- LOAD DATA ----
async function refresh(){
  const r = await fetch(DATABASE_URL);
  spotsData = await r.json() || {};
  draw();
}

// ---- DRAW SPOTS ----
async function draw(){
  const map = document.getElementById("map");
  document.querySelectorAll(".spot").forEach(e=>e.remove());

  const coords = await fetch("EDITOR-230-SPOTS(1).html")
    .then(r=>r.text());

  const match = coords.match(/\[(.|\n)*\]/);
  if(!match) return;

  const spots = JSON.parse(match[0]);

  spots.forEach(s=>{
    const d = document.createElement("div");
    d.className="spot";
    d.style.left=s.x+"px";
    d.style.top=s.y+"px";
    d.style.width=s.w+"px";
    d.style.height=s.h+"px";
    d.style.transform=`rotate(${s.rotation}deg)`;
    d.innerText=s.id;

    const data = spotsData[s.id];
    if(data){
      if(data.status==="NO FIT") d.classList.add("nofit");
      else d.classList.add("fit");
    }

    d.onclick=()=>{
      document.querySelectorAll(".spot").forEach(x=>x.classList.remove("selected"));
      d.classList.add("selected");
      selectedSpotId=s.id;
    };
    map.appendChild(d);
  });
}

// ---- HELPERS ----
function getSpotData(id){
  return spotsData[id] || null;
}

// ---- SEARCH ----
function searchBus(){
  const q=document.getElementById("searchInput").value.trim().toLowerCase();
  if(!q) return;

  document.querySelectorAll(".spot").forEach(s=>s.classList.remove("highlight"));

  for(const id in spotsData){
    if(spotsData[id].fleetNumber===q){
      const el=[...document.querySelectorAll(".spot")].find(x=>x.innerText===id);
      if(el){
        el.classList.add("highlight");
        el.scrollIntoView({behavior:"smooth",block:"center"});
        selectedSpotId=id;
      }
      return;
    }
  }
  alert("Bus not found");
}

// ---- ASSIGN ----
async function assignBus(){
  if(!selectedSpotId) return alert("Select a parking first");

  const current=getSpotData(selectedSpotId);
  if(current && current.status==="NO FIT"){
    alert("❌ NO FIT. Mark as FIT or CLEAR first.");
    return;
  }

  const bus=prompt("Fleet / Bonnet:");
  if(!bus) return;

  spotsData[selectedSpotId]={fleetNumber:bus.toLowerCase(),status:"FIT"};
  save();
}

// ---- FIT / CLEAR ----
function markFit(){
  if(!selectedSpotId) return alert("Select a parking");
  const d=spotsData[selectedSpotId]||{};
  d.status="FIT";
  spotsData[selectedSpotId]=d;
  save();
}
function clearSpot(){
  if(!selectedSpotId) return alert("Select a parking");
  delete spotsData[selectedSpotId];
  save();
}

function save(){
  localStorage.setItem("np-spots",JSON.stringify(spotsData));
  draw();
}

document.getElementById("menuBtn").onclick=()=>{
  document.getElementById("sidebar").classList.toggle("open");
};

refresh();
</script>

</body>
</html>
